'use strict';

var _ = require('lodash');
var cookieModule = require('cookie');

function serializeCookies(cookies, sessionCookieName) {
  var cookieNames = Object.keys(cookies);
  var filteredCookies = cookieNames.filter(function (name) {
    return !shouldStripClientCookie(name, sessionCookieName);
  });
  if (filteredCookies.length === 0) {
    return null;
  }
  return filteredCookies.map(function (name) {
    return cookieModule.serialize(name, cookies[name], { encode: same });
  }).join('; ');
}

function same(value) {
  return value;
}

function shouldStripClientCookie(name, sessionCookieName) {
  return (name === sessionCookieName) ||
    (name === '__VCAP_ID__') ||
    (_.startsWith(name.toLowerCase(), 'sapextlb'));
}

module.exports = function stripClientCookies(req, sessionCookieName) {
  if (!req.headers.cookie) {
    return;
  }
  var cookiesMap = cookieModule.parse(req.headers.cookie, { decode: same });
  req.headers.cookie = serializeCookies(cookiesMap, sessionCookieName);
  if (req.headers.cookie === null) {
    delete req.headers.cookie;
  }
};
