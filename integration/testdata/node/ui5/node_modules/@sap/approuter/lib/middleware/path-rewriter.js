'use strict';

var _ = require('lodash');
var urlUtils = require('../utils/url-utils');
var dynamicRoutingUtils = require('../utils/dynamic-routing-utils');
var businessServiceUtils = require('../utils/business-service-utils');

module.exports = function (req, matchHttpMethods /* default undefined, does not make sense for WebSockets */) {
  matchHttpMethods = !!matchHttpMethods; // Normalize to boolean

  var routerConfig = req.routerConfig;
  var routes = routerConfig.appConfig.routes;
  if (!routes) {
    return;
  }

  var url = dynamicRoutingUtils.getCoreUrl (req);

  /*
   * Record here which HTTP methods are supported by routes that match the path.
   * If any is recorded by the end of an unsuccessful route matching, then
   * there were paths matching but supporting other HTTP methods.
   */
  var supportedHttpMethods = [];
  for (var i = 0; i < routes.length; i++) {
    var route = routes[i];
    if (!route.source.test(url)) {
      continue;
    }

    if (!matchHttpMethods || httpMethodsMatch(route.httpMethods, req.method)) {
      var rewrittenUrl = applyRewriteRule(req, route, routerConfig);
      return rewrittenUrl;
    }

    supportedHttpMethods = supportedHttpMethods.concat(route.httpMethods);
  }

  if (matchHttpMethods && supportedHttpMethods.length) {
    /*
     * Remove potential duplicates in case multiple routes
     * matching by path support same HTTP method
     */
    req.supportedHttpMethods = _.uniq(supportedHttpMethods).sort();
  }
};

function httpMethodsMatch(allowedHttpMethods, requestMethod) {
  return !Array.isArray(allowedHttpMethods) || allowedHttpMethods.indexOf(requestMethod.toUpperCase()) > -1;
}

function applyRewriteRule(req, route, routerConfig) {
  var destination = route.destination;
  var useService = route.service ? true : false;
  var path;
  var serviceDestination;

  var url = dynamicRoutingUtils.getCoreUrl (req);

  if (route.target) {
    path = url.replace(route.source, route.target);
  } else {
    path = url;
  }
  var rewrittenUrl = null;
  var credentials = null;
  if (destination) {
    var oDestination = routerConfig.destinations[destination];
    rewrittenUrl = urlUtils.parse(_.trimEnd(oDestination.url, '/') + '/' + _.trimStart(path, '/'));
    rewrittenUrl.destination = oDestination;
  }  else if (useService){
    credentials = businessServiceUtils.getCredentials(route.service);
    serviceDestination = businessServiceUtils.getEndPoint(credentials, route.endpoint);

    if (dynamicRoutingUtils.isHtml5RepoService(route.service)) {
      path = dynamicRoutingUtils.getFullPathWithoutPrefix (req, path);
    }

    rewrittenUrl = urlUtils.parse(_.trimEnd(serviceDestination.url, '/') + '/' + _.trimStart(path, '/'));
    rewrittenUrl.destination = serviceDestination;
  } else {
    rewrittenUrl = urlUtils.parse(path);
  }
  rewrittenUrl.route = route;
  if (useService && credentials){
    rewrittenUrl.route.credentials = credentials;
  }
  return rewrittenUrl;
}
