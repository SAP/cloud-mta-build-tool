'use strict';

var basicAuthHeaderParser = require('basic-auth');
var cookie = require('cookie');
var cookieUtils = require('../utils/cookie-utils');
var oauthConfig = require('./../passport/oauth-configuration');
var passport = require('passport');
var headerUtil = require('../utils/header-util');
var pathUtil = require('../utils/path-util');

module.exports = {
  isLoginRequired: function (req) {
    var isPublicPath = pathUtil.isPublicPath(req);
    var isUserLoggedIn = module.exports.isUserLoggedIn(req);
    return !isPublicPath && !isUserLoggedIn;
  },

  isUserLoggedIn: function (req) {
    var user = req.session && req.session.user;
    if (!user || !user.token.accessToken || !user.token.expiryDate) {
      return false;
    }
    return user.token.expiryDate > Date.now();
  },

  getAuthenticator: function (req, res, cb) {
    if (pathUtil.isBasicAuthProtectedPath(req)) {
      return getBasicAuthAuthenticator(req, cb);
    }

    getXSUAAOauthAuthenticator(req, function(err, authenticator) {
      if (err) { return cb(err); }

      if (process.env.PRESERVE_FRAGMENT === 'false') {
        var redirectCookieName = cookieUtils.getRedirectLocationCookieName();
        var cookies = (req.headers.cookie && cookie.parse(req.headers.cookie)) || {};
        var redirectCookie = cookies[redirectCookieName];
        if (!redirectCookie) {
          var locationAfterLogin = cookie.serialize(redirectCookieName, req.url, {path: '/', httpOnly: true});
          cookieUtils.setCookie(res, locationAfterLogin);
        }
      }
      res.setHeader('Cache-Control', headerUtil.NOCACHE_HEADER_VALUE);
      cb(null, authenticator);
    });
  }
};

function getXSUAAOauthAuthenticator(req, cb) {
  oauthConfig.getXSUAAOauthStrategy(req, function(err, oauthStrategy) {
    if (err) { return cb(err);}
    cb(null, createAuthenticator(oauthStrategy));
  });
}

function getBasicAuthAuthenticator(req, cb) {
  var basicAuthHeader = basicAuthHeaderParser(req);
  if (!basicAuthHeader) {
    return cb(401);
  }

  var credentials = {
    username: basicAuthHeader.name,
    password: basicAuthHeader.pass
  };

  oauthConfig.getBasicOauthStrategy(req, credentials, function(err, oauthStrategy) {
    if (err) { return cb(err);}
    cb(null, createAuthenticator(oauthStrategy));
  });
}

function createAuthenticator(oauthStrategy) {
  passport.use(oauthStrategy);
  return passport.authenticate(oauthStrategy.name);
}
