'use strict';

var Cache = require('lru-cache');
var HttpProxyAgent = require('http-proxy-agent');
var HttpsProxyAgent = require('https-proxy-agent');
var HttpKeepAliveAgent = require('agentkeepalive');
var HttpsKeepAliveAgent = HttpKeepAliveAgent.HttpsAgent;


exports.proxyAgentsCache = new Cache(10);
exports.httpAgent = new HttpKeepAliveAgent();
exports.httpsAgent = new HttpsKeepAliveAgent();


function isSecureConnection(protocol) {
  return protocol === 'https:' || protocol === 'wss:';
}

exports.get = function (protocol, proxy, connectivityScenario) {
  var isSecure = connectivityScenario ? false : isSecureConnection(protocol);
  if (proxy) {
    return retrieveProxyAgent(proxy, isSecure);
  }
  return isSecure ? exports.httpsAgent : exports.httpAgent;
};

function retrieveProxyAgent(proxy, isSecure) {
  var id = buildIdentifier(proxy, isSecure);
  var agent = exports.proxyAgentsCache.get(id);
  if (agent) {
    return agent;
  }
  agent = isSecure ? new HttpsProxyAgent(proxy) : new HttpProxyAgent(proxy);
  exports.proxyAgentsCache.set(id, agent);
  return agent;
}

function buildIdentifier(proxy, isSecure) {
  var suffix = isSecure ? 'secure' : 'plain';
  return proxy + ':' + suffix;
}
