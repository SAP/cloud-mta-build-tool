'use strict';

var _ = require('lodash');

var X_FRAME_OPTIONS = 'x-frame-options';

module.exports = function additionalHeaders(req, res, next) {
  var routerConfig = req.routerConfig;
  var additionalHeaders = routerConfig.additionalHeaders;

  if (routerConfig.sendXFrameOptions) {
    var xFrameHeader = _.find(additionalHeaders, function searchXFrame(header) { return !!header[X_FRAME_OPTIONS]; });
    if (!xFrameHeader) {
      res.setHeader(X_FRAME_OPTIONS, 'SAMEORIGIN');
    }
  }
  additionalHeaders.forEach(function addAdditionalHeader(header) {
    _.forEach(header, function setHeader(value, name) {
      // http://tools.ietf.org/html/rfc7230#section-3.2.2
      // If the value of a header is an array, then it is serialized as comma separated list.
      var currentValue = res.getHeader(name);
      if (currentValue === undefined) {
        res.setHeader(name, value);
      } else if (Array.isArray(currentValue)) {
        currentValue.push(value);
      } else { // string
        res.setHeader(name, [currentValue, value]);
      }
    });
  });

  next();
};
