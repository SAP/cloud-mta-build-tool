'use strict';

var xsenv = require('@sap/xsenv');
var businessServiceUtils = require('./business-service-utils');
var validators = require('../configuration/validators');
var passportUtils = require('../passport/utils');
var loggerUtils = require('./logger');
var tracer = loggerUtils.getTracer(__filename);

var logger = loggerUtils.getLogger('/token-utils');
var VError = require('verror').VError;

exports.getProxyToken = getProxyToken;
exports.getHTML5AppsRepoToken = getHTML5AppsRepoToken;
exports.getTokens = getTokens;
exports.getDestinationTokenAndUrl = getDestinationTokenAndUrl;
exports.loadDestinationTokenAsync = loadDestinationTokenAsync;

function getDestinationTokenAndUrl(serviceCredentials) {
  try {
    serviceCredentials = serviceCredentials ? serviceCredentials : loadDestinationServiceCredentials();
    serviceCredentials.label = 'destination';
    validators.validateDestinationCredentials(serviceCredentials);
    return {
      token: loadClientCredentialsTokenSync(serviceCredentials),
      uri: serviceCredentials.uri
    };
  } catch (e) {
    logger.error('can\'t get access token to the destination service :\n', e);
  }
}

function getProxyToken(app) {
  try {
    var credentials = xsenv.cfServiceCredentials({tag: 'connectivity'});
    validators.validateConnectivityCredentials(credentials);
    loadClientCredentialsToken(app, credentials, 'connProxyToken');
// eslint-disable-next-line no-empty
  } catch (e) {}
}

function getHTML5AppsRepoToken(app) {
  try {
    var credentials = businessServiceUtils.getCredentials('html5-apps-repo-rt');
  } catch (e) {return;}
  try {
    validators.validateHTML5AppsRepoCredentials(credentials);
    loadClientCredentialsToken(app, credentials.uaa, 'html5AppsRepoToken');
  } catch (e){
    logger.error('can\'t get access token to html5 applications repository runtime service :\n', e);
  }
}

function getTokens(app) {
  getProxyToken(app);
  getHTML5AppsRepoToken(app);
  loadDestinationTokenAsync (app);
}

function loadDestinationTokenAsync (app) {
  var credentials;
  var message;
  try {
    credentials = xsenv.cfServiceCredentials({tag: 'destination'});
  } catch (e) {
    return;
  }
  try {
    validators.validateDestinationCredentials(credentials);
  } catch (e) {
    message = 'cannot get access token to destination service :\n' + e.message;
    logger.error(message);
    throw new VError(message);
  }
  loadClientCredentialsToken(app, credentials, 'destinationToken');
}

function loadDestinationServiceCredentials() {
  try {
    return xsenv.cfServiceCredentials({tag: 'destination'});
  } catch (err) {
    throw new Error('Error reading credentials for destination service. Please verify service is bound. ' + err);
  }
}

function loadClientCredentialsToken(app, credentials, tokenName) {
  var requestOptions = {
    url: credentials.url + '/oauth/token/?grant_type=client_credentials',
    headers: {
      'content-type': 'application/x-www-form-urlencoded;charset=utf-8',
      'accept': 'application/json;charset=utf-8'
    },
    auth: {
      user: credentials.clientid,
      pass: credentials.clientsecret
    }
  };

  passportUtils.callUaa(requestOptions, null, function (err, uaaResponse) {
    if (err) {
      return tracer.error('Error getting ' + credentials.label + ' client credentials from UAA. Number of attempts done: %d, error: %s',
                passportUtils.MAX_ATTEMPTS_NUMBER, err.message);
    }

    if (!uaaResponse.access_token || !uaaResponse.expires_in) {
      return tracer.error('Bad response from UAA when getting client credentials token for ' + credentials.label + '- not all fields are present');
    }
    var options = {
      accessToken: uaaResponse.access_token,
      expiryDate: passportUtils.getExpiresAt(uaaResponse.expires_in).getTime()
    };
    app[tokenName] = options;
    var tokenRefreshTimestamp = options.expiryDate - toMilliseconds(5);
    var msBeforeRetrieval = tokenRefreshTimestamp - Date.now();
    executeAfter(function () {
      loadClientCredentialsToken(app, credentials, tokenName);
    }, msBeforeRetrieval);
  });
}

function loadClientCredentialsTokenSync(credentials) {
  var url = credentials.url + '/oauth/token/?grant_type=client_credentials';
  var requestOptions = {
    headers: {
      'content-type': 'application/x-www-form-urlencoded;charset=utf-8',
      'accept': 'application/json;charset=utf-8',
      'authorization': 'Basic ' + Buffer(credentials.clientid + ':' + credentials.clientsecret).toString('base64')
    }
  };
  var uaaResponse = passportUtils.callUaaSync(url, requestOptions);
  if (!uaaResponse.access_token || !uaaResponse.expires_in) {
    throw new VError('Bad response from UAA when getting client credentials token for ' + credentials.label + '- not all fields are present');
  }
  return {
    accessToken: uaaResponse.access_token,
    expiryDate: passportUtils.getExpiresAt(uaaResponse.expires_in).getTime()
  };
}


function executeAfter(fn, timeout) {
  setTimeout(fn, timeout);
}

function toMilliseconds(minutes) {
  return minutes * 60 * 1000;
}
