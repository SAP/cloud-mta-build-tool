'use strict';

var traceUtil = require('../utils/trace-util');
var requestStats = require('request-stats');
var requestTraceEnabled = traceUtil.requestTraceEnabled;

module.exports = function traceRequestMiddleware(req, res, next) {
  var tracer = req.loggingContext.getTracer(__filename);
  traceUtil.traceIncomingRequest(tracer, req);
  if (requestTraceEnabled) {
    var logger = req.loggingContext.getLogger('/request/incoming');
    requestStats(req, res, function (stats) {
      if (!stats.ok) {
        logger.info('connection to %s was not closed correctly', stats.req.path);
      }
      logger.info('%s to %s took %d ms to complete with status code %d. %d bytes sent by the client. %d bytes sent back to the client',
        stats.req.method,
        stats.req.path,
        stats.time,
        stats.res.status,
        stats.req.bytes,
        stats.res.bytes);
    });
  }
  next();
};
