'use strict';

var deepmerge = require('deepmerge');
var sessionExt = require('../utils/session-ext');

module.exports = function cacheRequestData (req, res, next) {

  if (!req.toBeCachedOnSession || !req.toBeCachedOnSession.user) {
    return next ();
  }

  sessionExt.update(req.session, function(session) {
    if (session.user) {
      session.user = deepmerge (session.user, req.toBeCachedOnSession.user);
    }
  });

  delete req.toBeCachedOnSession;

  next ();
};