'use strict';

var xsrfTokenHandler = require('./xsrf-token-handler');
var dynamicRoutingUtils = require('../utils/dynamic-routing-utils');

module.exports = function welcomePage(req, res, next) {
  var welcomeFile = req.routerConfig.appConfig.welcomeFile;

  var url = dynamicRoutingUtils.getCoreUrl (req);

  if (welcomeFile && /^\/(\?.*$)?$/.test(url)) {
    var tracer = req.loggingContext.getTracer(__filename);
    if (welcomeFile[0] !== '/') {
      welcomeFile = '/' + welcomeFile;
    }
    tracer.info('Incoming request: "%s" will use welcome page "%s"', req.url, welcomeFile);

    if (!xsrfTokenHandler.isTokenFetchRequest(req)) {
      res.writeHead(302, { Location: dynamicRoutingUtils.getFullUrl (req, welcomeFile) });
      return res.end();
    }

    req.url = dynamicRoutingUtils.getFullUrl (req, welcomeFile);
  }
  next();
};
