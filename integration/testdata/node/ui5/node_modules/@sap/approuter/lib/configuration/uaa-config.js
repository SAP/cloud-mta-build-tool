'use strict';

var _ = require('lodash');
var path = require('path');
var xsenv = require('@sap/xsenv');
var VError = require('verror').VError;
var tracer = require('../utils/logger').getTracer(__filename);

exports.load = function (workingDir) {
  var pathToDefaultServices = path.join(workingDir, 'default-services.json');
  try {
    return xsenv.getServices({ uaa: matchesUaa }, pathToDefaultServices).uaa;
  } catch (e) {
    tracer.debug(new VError(e, 'Cannot find service uaa in environment'));
    return {};
  }
};

function matchesUaa(service) {
  var uaaName = process.env.UAA_SERVICE_NAME;
  if (uaaName) {
    return service.name === uaaName;
  }

  if (_.includes(service.tags, 'xsuaa')) {
    return true;
  }
  if (service.label === 'user-provided' && _.includes(service.credentials.tags, 'xsuaa')) {
    return true;
  }
  return false;
}
