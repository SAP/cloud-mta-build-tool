'use strict';

var moment = require('moment');
var os = require('os');
var colorize = require('winston').config.colorize;
var replaceNewLinesOnXSA = require('../common').replaceNewLinesOnXSA;

// Reference: http://help.sap.com/saphelp_nw74/helpdata/en/48/4f3966e39472d2e10000000a42189c/content.htm

exports.createFormatter = function (shouldUseColors) {
  return function (options) {
    return buildEntry(options.message, options.level, options.meta.messageContext, shouldUseColors);
  };
};

function buildEntry(message, level, messageContext, shouldUseColors) {
  var reqContext = messageContext.reqContext;
  var error = messageContext.error;
  if (error) {
    if (error.message) {
      if (message) {
        message += ': ' + error.message; // like verror & Linux
      } else {
        message = error.message;
      }
    }
    if (error.stack) {
      message += os.EOL + error.stack;
    }
  }
  var levelField = level.toUpperCase();
  var entry = [
    moment().format('MMM DD, YYYY hh:mm:ss A'),
    processTextualValue(messageContext.location),
    processTextualValue(buildRequestIdSection(reqContext)), // instead of Thread Name
    ((shouldUseColors) ? colorize(level, levelField) : levelField) + ':',
    processTextualValue(message)
  ];

  return entry.join(' ');
}

function buildRequestIdSection(reqContext) {
  var reqId = reqContext._id || '';
  return '[' + reqId + ']';
}

function processTextualValue(value) {
  return value ? replaceNewLinesOnXSA(value) : '';
}
