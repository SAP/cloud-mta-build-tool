'use strict';

var SAPPassport = require('@sap/e2e-trace').Passport;
var Logger = require('./logging-tools/Logger');
var Tracer = require('./logging-tools/Tracer');

module.exports = RequestContext;

function RequestContext(appContext, req, id) {
  this.requestId = resolveId(appContext, req, id);
  this._appContext = appContext;
  this._req = req;
  if (req && req.headers[SAPPassport.HEADER_NAME]) {
    this._passportFields = new SAPPassport(req.headers[SAPPassport.HEADER_NAME]).readUniqueIdentifiers();
  }
}

RequestContext.prototype.getLogger = function (category) {
  return new Logger(this, category);
};

RequestContext.prototype.getTracer = function (location) {
  return new Tracer(this, location);
};

RequestContext.prototype._shorten = function () {
  var req = this._req;
  return {
    _appContext: this._appContext._shorten(),
    _id: this.requestId,
    _user: req && req.user && req.user.id,
    _sessionId: req && req.session && req.session.id,
    _passportFields: this._passportFields
  };
};

function resolveId(appContext, req, id) {
  if (id !== undefined && id !== null) {
    return id;
  }

  if (!req) {
    return appContext._idGenerator.nextId();
  }

  return req.headers['x-request-id'] ||
    req.headers['x-correlationid'] ||
    req.headers['x-vcap-request-id'] ||
    appContext._idGenerator.nextId();
}
